<!DOCTYPE html>
<html>
<head>
  
    <title>Webcam Capture</title>
</head>
<body>
    <video id="video" width="640" height="480"  autoplay ></video>
    <button id="capture">Capture</button>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    <button id="connectButton">Connect Serial Port</button>

    <script>
        // Déclarer les variables globales pour la vidéo et le canvas
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');

        // Fonction pour demander l'accès au port série
        async function requestSerialPort() {
            try {
                // Demander à l'utilisateur de sélectionner un port série
                const port = await navigator.serial.requestPort();

                // Ouvrir le port série
                await port.open({ baudRate: 9600 }); // Spécifier le débit en bauds (baudRate)

                // Créer un lecteur pour lire les données du port série
                const reader = port.readable.getReader();

                // Lire continuellement les données du port série
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        console.log('Fin de la lecture du port série.');
                        break;
                    }
                    processData(new TextDecoder().decode(value));
                }

                // Masquer le bouton après l'autorisation
                document.getElementById('connectButton').style.display = 'none';
            } catch (error) {
                console.error('Erreur lors de l\'accès au port série :', error);
            }
        }

        // Fonction pour traiter les données reçues du port série
        function processData(data) {
            console.log('Données reçues du port série :', data);
            capturePhoto();
        }

        // Fonction pour capturer une photo
        function capturePhoto() {
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            var imageData = canvas.toDataURL('image/jpeg'); // Convertir en base64
            sendData(imageData); // Envoyer les données à la fonction sendData()
        }

        // Capture vidéo et envoi d'image
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                video.srcObject = stream;
            })
            .catch(function(error) {
                console.log("Error accessing the webcam: " + error.message);
            });

        document.getElementById('capture').addEventListener('click', function() {
            capturePhoto();
        });

        // Ajouter un écouteur d'événements au bouton pour demander l'accès au port série
        document.getElementById('connectButton').addEventListener('click', requestSerialPort);

        // Fonction pour envoyer les données de l'image au serveur
        function sendData(imageData) {
            fetch('/process_image', {
                method: 'POST',
                body: JSON.stringify({ image: imageData }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Image uploaded successfully');
            })
            .catch(error => {
                console.error('Error uploading image:', error);
            });
        }
        var videoConstraints = {
            video: {
                whiteBalanceMode: 'manual',  // Vous pouvez ajuster ce paramètre
                brightness: 2,              // Vous pouvez ajuster ce paramètre
                contrast: 1,                // Vous pouvez ajuster ce paramètre
                // Ajoutez d'autres paramètres si nécessaire
            }
        };
 
        navigator.mediaDevices.getUserMedia(videoConstraints)
            .then(function (stream) {
                var videoElement = document.getElementById('video');
                videoElement.srcObject = stream;
            })
            .catch(function (error) {
                console.error('Error accessing webcam:', error);
            });
    </script>
</body>
</html>
